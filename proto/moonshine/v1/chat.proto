syntax = "proto3";

package moonshine.v1;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";

// ChatService handles sending and streaming messages.
service ChatService {
  // SendMessage sends a single message to a channel.
  rpc SendMessage(SendMessageRequest) returns (SendMessageResponse) {}
  // GetMessages retrieves message history for a channel.
  rpc GetMessages(GetMessagesRequest) returns (GetMessagesResponse) {}
  // StreamMessages opens a server-streaming connection for real-time messages.
  rpc StreamMessages(StreamMessagesRequest) returns (stream StreamMessagesResponse) {}
}

message Message {
  string id = 1;
  string channel_id = 2;
  string user_id = 3;
  string username = 4;
  string content = 5;
  google.protobuf.Timestamp created_at = 6;
}

message SendMessageRequest {
  string channel_id = 1 [(buf.validate.field).string.uuid = true];
  string content = 2 [(buf.validate.field).string = {min_len: 1, max_len: 4000}];
}

message SendMessageResponse {
  Message message = 1;
}

message GetMessagesRequest {
  string channel_id = 1 [(buf.validate.field).string.uuid = true];
  // cursor is the message ID to paginate from (optional).
  string cursor = 2;
  int32 limit = 3;
}

message GetMessagesResponse {
  repeated Message messages = 1;
  string next_cursor = 2;
}

message StreamMessagesRequest {
  string channel_id = 1 [(buf.validate.field).string.uuid = true];
}

message StreamMessagesResponse {
  Message message = 1;
}
